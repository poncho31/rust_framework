


<div class="desktop_widget">
    <header class="modal_header">
        <b>Heure :</b> <div class="desktop_clock"></div>
    </header>
    <br>
    <header class="modal_header desktop_weather_info"></header>

    <br>
    <header class="modal_header desktop_flight_info"></header>

    <br>
    <header class="modal_header desktop_joke_info"></header>

    <br>
    <header class="modal_header desktop_github_info"></header>
</div>


<script>

    document.addEventListener('DOMContentLoaded', () => {
        fetchFlightInfo();
        setInterval(fetchFlightInfo, 60000);

        fetchJoke();
        setInterval(fetchJoke, 60000);

        fetchWeather();
        setInterval(fetchWeather, 60000);

        fetchGitHubInfo();
    });

    // Fonction qui retourne une ic√¥ne Unicode en fonction de la condition m√©t√©o
    function getWeatherIcon(condition) {
        console.log("CONDITION", condition);
        const cond = condition.toLowerCase();
        if (cond.includes('clear')) return  'üåô';
        if (cond.includes('sunny')) return '‚òÄÔ∏è';
        if (cond.includes('cloud')) return '‚òÅÔ∏è';
        if (cond.includes('rain')) return 'üåßÔ∏è';
        if (cond.includes('snow')) return '‚ùÑÔ∏è';
        if (cond.includes('thunder')) return '‚õàÔ∏è';
        return 'üå°Ô∏è';
      }
      
  
    function fetchWeather() {
      // On r√©cup√®re les donn√©es m√©t√©o au format JSON depuis wttr.in
      fetch('https://wttr.in/?format=j1')
        .then(response => response.json())
        .then(data => {
          const now = new Date().toLocaleTimeString();
  
          // R√©cup√©ration des donn√©es principales
          const nearestArea = data.nearest_area && data.nearest_area[0];
          const location    = nearestArea ? nearestArea.areaName[0].value : 'N/A';
          const current     = data.current_condition && data.current_condition[0];
          const temp        = current ? current.temp_C : 'N/A';
          const condition   = current ? current.weatherDesc[0].value : 'N/A';
          const icon        = getWeatherIcon(condition);
  
          // R√©cup√©ration d'informations compl√©mentaires
          const humidity  = current ? current.humidity      : 'N/A';
          const windSpeed = current ? current.windspeedKmph : 'N/A';
          const precip    = current ? current.precipMM      : 'N/A';
  
          // Mise √† jour du widget m√©t√©o avec des informations pr√©cises et des ic√¥nes
          document.querySelectorAll('.desktop_weather_info').forEach(el => {
            el.innerHTML = `
              ${location}
              <table class="" >
                    <tr>
                        <td><div class="button is-warning is-small  has-text-weight-bold" style="font-size:20px; margin:0: padding:0;" >${temp}¬∞</div> </td>
                        <td>${condition} ${icon}</td>
                    </tr>
                    <tr>
                        <td>Humi : </td>
                        <td>${humidity}%</td>
                    </tr>
                    
                    <tr>
                        <td>Vent : </td>
                        <td>${windSpeed} km/h</td>
                    </tr>
                    <tr>
                        <td>Prec : </td>
                        <td>${precip} mm</td>
                    </tr>
              </table>
            `;
          });
        })
        .catch(error => console.error("Erreur lors de la r√©cup√©ration de la m√©t√©o:", error));
    }
  
    function fetchFlightInfo() {
      if (!navigator.geolocation) {
        document.querySelector('.desktop_flight_info').innerHTML =
          "<p>La g√©olocalisation n'est pas support√©e par votre navigateur.</p>";
        return;
      }
    
      navigator.geolocation.getCurrentPosition(successCallback, errorCallback);
    
      function successCallback(position) {
        const userLat = position.coords.latitude;
        const userLon = position.coords.longitude;
    
        fetch('https://opensky-network.org/api/states/all')
          .then(response => response.json())
          .then(data => {
            const states = data.states;
            if (!states) {
              throw new Error("Aucune donn√©e de vol disponible.");
            }
            let nearestFlight = null;
            let minDistance = Infinity;
    
            states.forEach(flight => {
              const flightLat = flight[6];
              const flightLon = flight[5];
              if (flightLat && flightLon) {
                const distance = haversine(userLat, userLon, flightLat, flightLon);
                if (distance < minDistance) {
                  minDistance = distance;
                  nearestFlight = flight;
                }
              }
            });
    
            if (nearestFlight) {
              const flightCallsign = nearestFlight[1] || "N/A";
              const flightCountry = nearestFlight[2] || "N/A";
              const flightLat = nearestFlight[6];
              const flightLon = nearestFlight[5];
              document.querySelector('.desktop_flight_info').innerHTML = `
                <div>Vol le plus proche</div>
                <div>
                  Appel : <a onclick="window.open('https://www.flightaware.com/live/flight/${flightCallsign}', 'new_window', 'width=800,height=600'); return false;">${flightCallsign}</a><br>
                  Pays : ${flightCountry}<br>
                  Distance : ${minDistance.toFixed(2)} km<br>
                  Coordonn√©es : ${flightLat}, ${flightLon}
                </div>
              `;
            } else {
              document.querySelector('.desktop_flight_info').innerHTML =
                "<p>Aucun vol trouv√© √† proximit√©.</p>";
            }
          })
          .catch(error => {
            console.error("Erreur lors de la r√©cup√©ration des infos de vol :", error);
            document.querySelector('.desktop_flight_info').innerHTML =
              "<p>Erreur lors de la r√©cup√©ration des infos de vol.</p>";
          });
      }
    
      function errorCallback(error) {
        console.error("Erreur de g√©olocalisation :", error);
        if (error.code === error.PERMISSION_DENIED) {
          document.querySelector('.desktop_flight_info').innerHTML =
            "<p>L'acc√®s √† la g√©olocalisation a √©t√© refus√©. Veuillez autoriser l'acc√®s pour r√©cup√©rer les infos de vol.</p>";
        } else {
          document.querySelector('.desktop_flight_info').innerHTML =
            `<p>Erreur de g√©olocalisation : ${error.message}</p>`;
        }
      }
    
      // Fonction utilitaire pour calculer la distance entre deux points (formule haversine)
      function haversine(lat1, lon1, lat2, lon2) {
        const toRad = (x) => x * Math.PI / 180;
        const R = 6371; // Rayon de la Terre en km
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }
    }
    
      
      // Module 2 : R√©cup√©rer une blague al√©atoire via l'API Official Joke
      function fetchJoke() {
        fetch('https://official-joke-api.appspot.com/random_joke')
          .then(response => response.json())
          .then(data => {
            document.querySelector('.desktop_joke_info').innerHTML = `
                <div style="font-size: 1rem; font-style: italic;">"${data.setup}"</div><br>
                <span class="has-text-warning has-text-right">${data.punchline}</span>
            `;
          })
          .catch(error => console.error("Erreur lors de la r√©cup√©ration de la blague :", error));
      }



      const owner       = '{{ page_builder.env["API_GITHUB_USERNAME"] }}';
      const repo        = '{{ page_builder.env["API_GITHUB_REPO"] }}';
      const githubToken = '{{ page_builder.env["API_GITHUB_PASSWORD"] }}';
    
      function fetchGitHubInfo() {
        fetch(`https://api.github.com/repos/${owner}/${repo}`, {
          headers: {
            Authorization: "token " + githubToken,
            Accept: "application/vnd.github.v3+json"
          }
        })
          .then(response => response.json())
          .then(data => {
            const createdAt = new Date(data.created_at).toLocaleDateString();
            const updatedAt = new Date(data.updated_at).toLocaleDateString();
      
            // Requ√™te pour r√©cup√©rer le nombre de commits en utilisant per_page=1
            fetch(`https://api.github.com/repos/${owner}/${repo}/commits?per_page=1`, {
              headers: {
                Authorization: "token " + githubToken,
                Accept: "application/vnd.github.v3+json"
              }
            })
              .then(response => {
                let commitCount = "N/A";
                const linkHeader = response.headers.get("Link");
                if (linkHeader) {
                  // Le header Link ressemble √† : <https://api.github.com/repositories/123456/commits?page=2>; rel="next", <https://api.github.com/repositories/123456/commits?page=34>; rel="last"
                  const match = linkHeader.match(/&page=(\d+)>; rel="last"/);
                  if (match) {
                    commitCount = match[1];
                  }
                } else {
                  // Si aucun header Link, on suppose qu'il n'y a qu'un seul commit
                  commitCount = "1";
                }
                return response.json().then(() => ({ commitCount }));
              })
              .then(({ commitCount }) => {
                document.querySelector('.desktop_github_info').innerHTML = `
                  <div class="content">
                    <h2 class="title is-6 has-text-primary">${data.full_name}</h2>
                    <p> ${data.description || "Pas de description."}</p>
                  </div>
                  <div>
                      ‚≠ê ${data.stargazers_count} <br>
                      üç¥ ${data.forks_count} <br>
                      üìù ${commitCount} commits <br>
                      Cr√©√© le : ${createdAt} <br> 
                      M√†J: ${updatedAt}
                  </div>
                `;
              })
              .catch(error => console.error("Erreur lors de la r√©cup√©ration du nombre de commits :", error));
          })
          .catch(error => console.error("Erreur lors de la r√©cup√©ration des infos GitHub :", error));
      }
      
      
    




  </script>
  