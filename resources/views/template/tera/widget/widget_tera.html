<div class="desktop_widget">
    <header class="modal_header">
        <b>Heure :</b> <div class="desktop_clock"></div>
    </header>
    <br>
    <header class="modal_header desktop_weather_info"></header>

    <br>
    <header class="modal_header desktop_flight_info"></header>

    <br>
    <header class="modal_header desktop_joke_info"></header>

    <br>
    <header class="modal_header desktop_github_info"></header>
</div>


<script>

    document.addEventListener('DOMContentLoaded', () => {
        fetchFlightInfo();
        setInterval(fetchFlightInfo, 60000);

        fetchJoke();
        setInterval(fetchJoke, 60000);

        fetchWeather();
        setInterval(fetchWeather, 60000);

        fetchGitHubInfo();
    });

    // Fonction qui retourne une ic√¥ne Unicode en fonction de la condition m√©t√©o
    function getWeatherIcon(condition) {
        console.log("CONDITION", condition);
        const cond = condition.toLowerCase();
        if (cond.includes('clear')) return  'üåô';
        if (cond.includes('sunny')) return '‚òÄÔ∏è';
        if (cond.includes('cloud')) return '‚òÅÔ∏è';
        if (cond.includes('rain')) return 'üåßÔ∏è';
        if (cond.includes('snow')) return '‚ùÑÔ∏è';
        if (cond.includes('thunder')) return '‚õàÔ∏è';
        return 'üå°Ô∏è';
      }
      
  
    function fetchWeather() {
      // On r√©cup√®re les donn√©es m√©t√©o au format JSON depuis wttr.in
      fetch('https://wttr.in/?format=j1')
        .then(response => response.json())
        .then(data => {
          const now = new Date().toLocaleTimeString();
  
          // R√©cup√©ration des donn√©es principales
          const nearestArea = data.nearest_area && data.nearest_area[0];
          const location    = nearestArea ? nearestArea.areaName[0].value : 'N/A';
          const current     = data.current_condition && data.current_condition[0];
          const temp        = current ? current.temp_C : 'N/A';
          const condition   = current ? current.weatherDesc[0].value : 'N/A';
          const icon        = getWeatherIcon(condition);
  
          // R√©cup√©ration d'informations compl√©mentaires
          const humidity  = current ? current.humidity      : 'N/A';
          const windSpeed = current ? current.windspeedKmph : 'N/A';
          const precip    = current ? current.precipMM      : 'N/A';
  
          // Mise √† jour du widget m√©t√©o avec des informations pr√©cises et des ic√¥nes
          document.querySelectorAll('.desktop_weather_info').forEach(el => {
            el.innerHTML = `
              ${location}
              <table class="" >
                    <tr>
                        <td><div class="button is-warning is-small  has-text-weight-bold" style="font-size:20px; margin:0: padding:0;" >${temp}¬∞</div> </td>
                        <td>${condition} ${icon}</td>
                    </tr>
                    <tr>
                        <td>Humi : </td>
                        <td>${humidity}%</td>
                    </tr>
                    
                    <tr>
                        <td>Vent : </td>
                        <td>${windSpeed} km/h</td>
                    </tr>
                    <tr>
                        <td>Prec : </td>
                        <td>${precip} mm</td>
                    </tr>
              </table>
            `;
          });
        })
        .catch(error => console.error("Erreur lors de la r√©cup√©ration de la m√©t√©o:", error));
    }
  
    function fetchFlightInfo() {
        fetch('https://api.spacexdata.com/v4/launches/latest')
          .then(response => response.json())
          .then(data => {
            const launchName = data.name || 'N/A';
            const launchDate = data.date_utc ? new Date(data.date_utc).toLocaleString() : 'N/A';
            const details = data.details || 'Pas de d√©tails disponibles.';
            
            document.querySelector('.desktop_flight_info').innerHTML = `
              <div style="font-size: 1.1rem; font-weight: bold;">Dernier vol SpaceX : ${launchName}</div>
              <div style="font-size: 0.9rem;">
                Date : ${launchDate}<br>
                D√©tails : ${details}
              </div>
            `;
          })
          .catch(error => console.error("Erreur lors de la r√©cup√©ration des infos de vol :", error));
      }
      
      // Module 2 : R√©cup√©rer une blague al√©atoire via l'API Official Joke
      function fetchJoke() {
        fetch('https://official-joke-api.appspot.com/random_joke')
          .then(response => response.json())
          .then(data => {
            document.querySelector('.desktop_joke_info').innerHTML = `
                <div style="font-size: 1rem; font-style: italic;">"${data.setup}"</div><br>
                <span class="has-text-warning has-text-right">${data.punchline}</span>
            `;
          })
          .catch(error => console.error("Erreur lors de la r√©cup√©ration de la blague :", error));
      }



      const owner       = '{{ page_builder.env["API_GITHUB_USERNAME"] }}';
      const repo        = '{{ page_builder.env["API_GITHUB_REPO"] }}';
      const githubToken = '{{ page_builder.env["API_GITHUB_PASSWORD"] }}';
    
      function fetchGitHubInfo() {
        fetch(`https://api.github.com/repos/${owner}/${repo}`, {
          headers: {
            Authorization: "token " + githubToken,
            Accept: "application/vnd.github.v3+json"
          }
        })
          .then(response => response.json())
          .then(data => {
            document.querySelector('.desktop_github_info').innerHTML = `
              <div class="content">
                <h2 class="title is-6 has-text-primary">${data.full_name}</h2>
              </div>
              <div>

                <p class="is-6">${data.description }</p>
                <p>
                  ‚≠ê ${data.stargazers_count} &nbsp;|&nbsp;
                  üç¥ ${data.forks_count}
                </p>

              </div>
            `;
          })
          .catch(error => console.error("Erreur lors de la r√©cup√©ration des infos GitHub :", error));
      }
      
    




  </script>
  